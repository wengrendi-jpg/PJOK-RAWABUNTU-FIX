<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - PJOK Kelas 4</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* TEMA ORANYE (KHAS KELAS 4) */
        body { font-family: 'Nunito', sans-serif; background: #fff3e0; margin: 0; padding: 20px; color: #333; }
        
        .header { background: linear-gradient(135deg, #ef6c00, #ffa726); color: white; padding: 15px 20px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(239,108,0,0.3); }
        .header h2 { margin: 0; font-size: 20px; font-weight: 800; }
        
        .btn-group { display: flex; gap: 10px; }
        .btn-action { padding: 10px 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 13px; color: white; display: flex; align-items: center; gap: 5px; transition: 0.2s; text-decoration: none; }
        .btn-excel { background: #2e7d32; } 
        .btn-reset { background: #b71c1c; } 
        .btn-menu { background: #fff; color: #ef6c00; }
        
        .panel-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 25px; border-left: 6px solid #ef6c00; }
        .card-title { font-weight: 800; font-size: 16px; margin-bottom: 20px; display: block; border-bottom: 2px dashed #ffe0b2; padding-bottom: 10px; color: #e65100; text-transform: uppercase; }

        .filter-container { display: flex; gap: 15px; background: #fff8e1; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ffe0b2; flex-wrap: wrap; }
        .form-control { padding: 12px; border: 1px solid #ffcc80; border-radius: 8px; flex: 1; min-width: 200px; font-family: 'Nunito'; outline: none; }
        .form-control:focus { border-color: #ef6c00; background: #fff; }

        .switch-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; }
        .switch-item { background: #fff3e0; padding: 10px; border-radius: 12px; text-align: center; border: 1px solid #ffe0b2; }
        .bab-label { font-weight: 800; font-size: 12px; margin-bottom: 5px; color: #e65100; display: block; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; margin-bottom: 5px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #ef6c00; }
        input:checked + .slider:before { transform: translateX(20px); }
        .status-text { font-size: 10px; font-weight: 800; display: block; color: #999; }

        .table-responsive { overflow-x: auto; border-radius: 10px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; background: white; white-space: nowrap; }
        th { background: #ef6c00; color: white; padding: 12px 10px; text-align: center; border: 1px solid #ffe0b2; font-weight: 800; }
        td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; border-right: 1px solid #eee; vertical-align: middle; }
        tr:hover { background-color: #fff3e0; }
        
        .nilai-box { font-weight: bold; color: #e65100; }
        .nilai-kosong { color: #ccc; }
        .bg-rata { background: #fff8e1; font-weight: 800; color: #bf360c; }
        .th-rata { background: #e65100; color: #fff; }

        .btn-del-mini { background: #ffcdd2; color: #c62828; border: 1px solid #ef9a9a; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: bold; }
        
        @media (max-width: 768px) { .filter-container { flex-direction: column; } .header { flex-direction: column; text-align: center; gap: 10px; } }
    </style>
</head>
<body>

    <div class="header">
        <h2>üéõÔ∏è PANEL KONTROL KELAS 4</h2>
        <div class="btn-group">
            <button onclick="downloadExcel()" class="btn-action btn-excel">üìä Excel</button>
            <button onclick="resetSemuaData()" class="btn-action btn-reset">üóëÔ∏è Reset</button>
            <a href="dashboard.html" class="btn-action btn-menu">üè† Menu</a>
        </div>
    </div>

    <div class="panel-card">
        <span class="card-title">üîí AKSES SOAL</span>
        <div class="switch-grid" id="container-switches"></div>
    </div>

    <div class="panel-card">
        <span class="card-title">üìù REKAP NILAI SISWA</span>
        <div class="filter-container">
            <input type="text" id="filterNama" class="form-control" placeholder="Cari Nama..." onkeyup="renderTabel()">
            <input type="text" id="filterSekolah" class="form-control" placeholder="Cari Sekolah..." onkeyup="renderTabel()">
            <select id="filterKelas" class="form-control" onchange="renderTabel()">
                <option value="">Semua Kelas</option>
                <option value="4A">4A</option><option value="4B">4B</option><option value="4C">4C</option>
                <option value="4D">4D</option><option value="4E">4E</option><option value="4F">4F</option>
            </select>
        </div>
        <div class="table-responsive">
            <table id="tabel-nilai">
                <thead>
                    <tr>
                        <th style="text-align:left; min-width:150px;">Nama Siswa</th>
                        <th>Kelas</th>
                        <th style="min-width:150px;">Sekolah</th>
                        <th>Guru</th>
                        <th>A</th> <th>B</th> <th>C</th> <th>D</th> 
                        <th style="background:#fb8c00;">STS</th>
                        <th class="th-rata">RATA 1</th> 
                        <th>E</th> <th>F</th> <th>G</th> <th>H</th>
                        <th style="background:#fb8c00;">SAS</th>
                        <th class="th-rata">RATA 2</th>
                        <th class="no-print">Aksi</th>
                    </tr>
                </thead>
                <tbody id="body-nilai"><tr><td colspan="16">Memuat data...</td></tr></tbody>
            </table>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyD7FsbgyUF1jvDvcrb6wrWlEiQJUFZG3kE", authDomain: "pjok-sekolah-bapak-rendi.firebaseapp.com", databaseURL: "https://pjok-sekolah-bapak-rendi-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "pjok-sekolah-bapak-rendi", appId: "1:337016584526:web:8534c7cf4012a35427861f" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const listBab = ['A', 'B', 'C', 'D', 'STS', 'E', 'F', 'G', 'H', 'SAS'];
        const smt1 = ['A', 'B', 'C', 'D'];
        const smt2 = ['E', 'F', 'G', 'H'];
        let rawData = {};

        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('container-switches');
            listBab.forEach(bab => {
                container.innerHTML += `<div class="switch-item"><span class="bab-label">BAB ${bab}</span><label class="switch"><input type="checkbox" id="toggle-${bab}" onchange="updateAkses('${bab}')"><span class="slider"></span></label><span class="status-text" id="status-${bab}">TERKUNCI</span></div>`;
            });

            db.ref('akses_soal/kelas_4').on('value', (snap) => {
                const data = snap.val() || {};
                listBab.forEach(bab => {
                    const isOpen = data[bab] === true;
                    const el = document.getElementById(`toggle-${bab}`);
                    const txt = document.getElementById(`status-${bab}`);
                    if(el) { el.checked = isOpen; txt.innerText = isOpen ? "BUKA" : "TUTUP"; txt.style.color = isOpen ? "#ef6c00" : "#999"; }
                });
            });

            db.ref('hasil_kuis/kelas_4').on('value', (snap) => {
                rawData = snap.val() || {};
                renderTabel();
            });
        });

        window.updateAkses = function(bab) {
            db.ref(`akses_soal/kelas_4/${bab}`).set(document.getElementById(`toggle-${bab}`).checked);
        };

        function hitungRata(data, babList, ujian) {
            let tot=0, c=0;
            babList.forEach(b => { if(data[b]){ tot+=parseInt(data[b]); c++; } });
            const h = c>0 ? tot/c : 0;
            const u = data[ujian] ? parseInt(data[ujian]) : 0;
            if(c===0 && !data[ujian]) return "-";
            return Math.round((h*0.7) + (u*0.3));
        }

        function renderTabel() {
            const tbody = document.getElementById('body-nilai');
            tbody.innerHTML = '';
            const fNama = document.getElementById('filterNama').value.toLowerCase();
            const fSekolah = document.getElementById('filterSekolah').value.toLowerCase();
            const fKelas = document.getElementById('filterKelas').value;

            let map = {};
            Object.keys(rawData).forEach(bab => {
                const d = rawData[bab];
                if(d) Object.keys(d).forEach(k => {
                    const s = d[k];
                    if(s && s.nama) {
                        const id = (s.nama + s.kelas).toLowerCase().replace(/\s/g,'');
                        if(!map[id]) map[id] = {nama:s.nama, kelas:s.kelas, sekolah:s.sekolah, guru:s.guru, nilai:{}, keys:[]};
                        map[id].nilai[bab] = s.nilai_pg;
                        map[id].keys.push(`hasil_kuis/kelas_4/${bab}/${k}`);
                    }
                });
            });

            let list = Object.values(map).filter(s => s.nama.toLowerCase().includes(fNama) && s.sekolah.toLowerCase().includes(fSekolah) && (fKelas==="" || s.kelas===fKelas));
            list.sort((a,b) => a.kelas.localeCompare(b.kelas) || a.nama.localeCompare(b.nama));

            if(list.length === 0) { tbody.innerHTML = '<tr><td colspan="16" style="padding:20px;text-align:center;">Data tidak ditemukan</td></tr>'; return; }

            list.forEach(s => {
                const r1 = hitungRata(s.nilai, smt1, 'STS');
                const r2 = hitungRata(s.nilai, smt2, 'SAS');
                let html = `<tr><td style="text-align:left;font-weight:bold;color:#bf360c;">${s.nama}</td><td>${s.kelas}</td><td style="color:#ef6c00;">${s.sekolah}</td><td>${s.guru}</td>`;
                smt1.forEach(b => html += `<td>${s.nilai[b]||'-'}</td>`);
                html += `<td style="background:#fff3e0;font-weight:bold;">${s.nilai['STS']||'-'}</td><td class="bg-rata">${r1}</td>`;
                smt2.forEach(b => html += `<td>${s.nilai[b]||'-'}</td>`);
                html += `<td style="background:#fff3e0;font-weight:bold;">${s.nilai['SAS']||'-'}</td><td class="bg-rata">${r2}</td>`;
                html += `<td class="no-print"><button class="btn-del-mini" onclick="hapus('${s.keys.join(',')}')">Hapus</button></td></tr>`;
                tbody.innerHTML += html;
            });
        }

        window.hapus = function(k) { if(confirm("Hapus data ini?")) { const u={}; k.split(',').forEach(x => u[x]=null); db.ref().update(u); } };
        window.resetSemuaData = function() { if(prompt("Ketik SETUJU untuk hapus semua:")==="SETUJU") db.ref('hasil_kuis/kelas_4').remove(); };
        window.downloadExcel = function() { const t=document.getElementById('tabel-nilai').cloneNode(true); t.querySelectorAll('.no-print').forEach(e=>e.remove()); XLSX.writeFile(XLSX.utils.table_to_book(t), "Nilai_K4.xlsx"); };
    </script>
</body>
</html>