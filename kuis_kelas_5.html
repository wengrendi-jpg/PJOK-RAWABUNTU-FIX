<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuis PJOK Kelas 5</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script src="bank_soal_5.js"></script>
    
    <style>
        /* TEMA UNGU (KHAS KELAS 5) */
        body { font-family: 'Nunito', sans-serif; background: #f3e5f5; margin: 0; padding: 0; color: #333; padding-bottom: 50px; }
        
        /* TIMER MELAYANG (STICKY) */
        .timer-bar { 
            position: fixed; top: 0; left: 0; right: 0; 
            background: #7b1fa2; color: white; padding: 15px; 
            text-align: center; font-size: 18px; font-weight: 800; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1000; 
            display: none; /* Muncul saat mulai */
        }
        
        .container { 
            max-width: 800px; margin: 80px auto 20px; 
            background: white; padding: 30px; border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 8px solid #7b1fa2; 
        }
        
        .section-header { background: #7b1fa2; color: white; padding: 12px; border-radius: 8px; margin: 30px 0 15px; font-weight: 800; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; text-align: center; }
        
        .soal-card { background: #fdfbff; border: 1px solid #e1bee7; padding: 20px; border-radius: 12px; margin-bottom: 20px; position: relative; }
        .number-badge { background: #4a148c; color: white; padding: 5px 12px; border-radius: 8px; font-weight: 800; margin-right: 10px; font-size: 14px; }
        
        .option-label { display: block; padding: 12px 15px; background: white; border: 2px solid #e1bee7; border-radius: 10px; margin-top: 10px; cursor: pointer; transition: 0.2s; font-weight: 600; }
        .option-label:hover { background: #f3e5f5; border-color: #7b1fa2; }
        
        /* Highlight Pilihan */
        input[type="radio"]:checked + span { font-weight: bold; color: #6a1b9a; }
        input[type="radio"] { margin-right: 10px; transform: scale(1.2); }
        
        /* Form Input */
        .form-control { width: 100%; padding: 12px; border: 2px solid #e1bee7; border-radius: 10px; font-family: inherit; font-size: 15px; margin-top: 8px; box-sizing: border-box; background-color: #fafafa; }
        .form-control[readonly] { background-color: #e0e0e0; cursor: not-allowed; font-weight: bold; color: #555; }

        /* Tombol */
        .btn { width: 100%; padding: 16px; border: none; border-radius: 50px; font-weight: 800; font-size: 16px; cursor: pointer; transition: 0.3s; color: white; margin-top: 20px; text-transform: uppercase; }
        .btn-start { background: #7b1fa2; box-shadow: 0 4px 10px rgba(123, 31, 162, 0.4); } 
        .btn-submit { background: #2e7d32; box-shadow: 0 4px 10px rgba(46, 125, 50, 0.4); }
        
        /* Hasil & Resume Alert */
        #area-hasil { display: none; text-align: center; padding: 40px 20px; }
        .score-circle { width: 150px; height: 150px; background: #7b1fa2; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 50px; font-weight: 800; margin: 20px auto; border: 8px solid #e1bee7; }
        
        .resume-alert { background: #fff3e0; color: #e65100; padding: 12px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffe0b2; display: none; text-align: center; font-weight: bold; font-size: 14px; }
        
        @keyframes blink { 50% { background-color: #d32f2f; } }
        .critical { animation: blink 1s infinite; }
    </style>
</head>
<body>

    <div id="timer-bar" class="timer-bar">
        ‚è≥ SISA WAKTU: <span id="time-display">--:--</span>
    </div>

    <div class="container">
        
        <div id="area-identitas">
            <h2 style="text-align:center; color:#4a148c; margin-top:0;">üìã DATA SISWA KELAS 5</h2>
            
            <div id="resume-msg" class="resume-alert">
                üì¢ Kamu belum menyelesaikan ujian sebelumnya. <br>Jawaban dan sisa waktumu telah dipulihkan.
            </div>

            <div style="margin-bottom:15px">
                <label>Nama Lengkap:</label>
                <input type="text" id="siswa_nama" class="form-control" readonly placeholder="Nama otomatis...">
            </div>
            
            <div style="margin-bottom:15px">
                <label>Kelas:</label>
                <input type="text" id="siswa_kelas" class="form-control" readonly placeholder="Kelas otomatis...">
            </div>

            <div style="margin-bottom:15px">
                <label>Asal Sekolah:</label>
                <input type="text" id="siswa_sekolah" class="form-control" placeholder="Contoh: SDN Cerdas 01">
            </div>
            
            <div style="margin-bottom:15px">
                <label>Nama Guru:</label>
                <input type="text" id="siswa_guru" class="form-control" placeholder="Nama Guru PJOK...">
            </div>
            
            <div style="text-align:center; margin-top:20px; color:#555; font-size:14px;" id="info-soal-count"></div>
            <button class="btn btn-start" onclick="mulaiKuis()">üöÄ MULAI / LANJUTKAN</button>
            <br><br>
            <a href="materi-kelas-5.html" style="text-decoration:none; color:#7b1fa2; font-weight:bold; display:block; text-align:center;">‚¨Ö Kembali ke Materi</a>
        </div>

        <div id="area-soal" style="display:none;">
            <div id="box-soal"></div>
            <button class="btn btn-submit" onclick="konfirmasiSelesai()">‚úÖ KIRIM JAWABAN</button>
        </div>

        <div id="area-hasil">
            <h2>LUAR BIASA!</h2>
            <div class="score-circle" id="skor-tampil">0</div>
            <p style="font-size:18px;">Jawabanmu sudah terkirim ke Pak Guru.</p>
            <button class="btn" style="background:#555" onclick="window.location.href='materi-kelas-5.html'">üè† KEMBALI KE MATERI</button>
        </div>
    </div>

    <script>
        // ===========================================
        // 1. KONFIGURASI SISTEM KELAS 5
        // ===========================================
        const KELAS = '5'; // Kunci Kelas 5
        const firebaseConfig = { apiKey: "AIzaSyD7FsbgyUF1jvDvcrb6wrWlEiQJUFZG3kE", authDomain: "pjok-sekolah-bapak-rendi.firebaseapp.com", databaseURL: "https://pjok-sekolah-bapak-rendi-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "pjok-sekolah-bapak-rendi", appId: "1:337016584526:web:8534c7cf4012a35427861f" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        const params = new URLSearchParams(window.location.search);
        const bab = params.get('bab') || 'A';
        
        // KUNCI PENYIMPANAN DI HP (Agar tidak bentrok dengan kelas lain)
        const STORAGE_KEY = `pjok_progress_k${KELAS}_${bab}_`; 
        
        let dataSoal = null;
        let timerInterval;
        let durasiDetik = 0;

        // ===========================================
        // 2. LOAD DATA SAAT BUKA HALAMAN
        // ===========================================
        document.addEventListener('DOMContentLoaded', () => {
            // Cek Bank Soal Kelas 5
            if(window.BANK_SOAL_5 && window.BANK_SOAL_5[bab]) {
                dataSoal = window.BANK_SOAL_5[bab];
                
                // Tentukan Waktu (Ujian 90 menit = 5400s, Harian 60 menit = 3600s)
                const isUjian = (bab === 'STS' || bab === 'SAS');
                const defaultWaktu = isUjian ? 5400 : 3600; 
                
                // CEK APAKAH ADA SISA WAKTU TERSIMPAN? (Fitur Resume)
                const savedTime = localStorage.getItem(STORAGE_KEY + 'waktu');
                if(savedTime && parseInt(savedTime) > 0) {
                    durasiDetik = parseInt(savedTime);
                    document.getElementById('resume-msg').style.display = 'block'; 
                } else {
                    durasiDetik = defaultWaktu;
                }

                // Info Jumlah Soal
                let totalSoal = (dataSoal.pg?.length||0) + (dataSoal.isian?.length||0) + (dataSoal.essay?.length||0);
                document.getElementById('info-soal-count').innerText = `Materi: ${bab} | Total: ${totalSoal} Soal`;

            } else {
                alert("‚ö†Ô∏è Data Soal tidak ditemukan! Kembali ke materi.");
                window.location.href = 'materi-kelas-5.html';
                return;
            }

            // Isi Otomatis Data Identitas dari Login (localStorage Dashboard)
            if(localStorage.getItem('siswa_nama')) document.getElementById('siswa_nama').value = localStorage.getItem('siswa_nama');
            if(localStorage.getItem('siswa_kelas')) document.getElementById('siswa_kelas').value = localStorage.getItem('siswa_kelas');
            
            // Restore Sekolah & Guru jika pernah mengisi sebelumnya
            if(localStorage.getItem('siswa_sekolah')) document.getElementById('siswa_sekolah').value = localStorage.getItem('siswa_sekolah');
            if(localStorage.getItem('siswa_guru')) document.getElementById('siswa_guru').value = localStorage.getItem('siswa_guru');
        });

        // ===========================================
        // 3. MULAI KUIS
        // ===========================================
        function mulaiKuis() {
            const nama = document.getElementById('siswa_nama').value;
            const kelas = document.getElementById('siswa_kelas').value;
            const sekolah = document.getElementById('siswa_sekolah').value;
            const guru = document.getElementById('siswa_guru').value;
            
            if(!nama || !kelas) { alert("Data Login tidak ditemukan. Silakan login ulang."); return; }
            if(!sekolah) { alert("Silakan isi Asal Sekolah!"); return; }
            if(!guru) { alert("Silakan isi Nama Guru PJOK!"); return; }

            // Simpan Sekolah & Guru agar tidak perlu ketik ulang nanti
            localStorage.setItem('siswa_sekolah', sekolah);
            localStorage.setItem('siswa_guru', guru);

            // Pindah Layar
            document.getElementById('area-identitas').style.display = 'none';
            document.getElementById('area-soal').style.display = 'block';
            document.getElementById('timer-bar').style.display = 'block';

            renderSoal();
            restoreJawaban(); // Pulihkan jawaban yang tersimpan (Auto-Restore)
            jalankanTimer();
        }

        // ===========================================
        // 4. RENDER SOAL & INPUT
        // ===========================================
        function renderSoal() {
            let html = "";
            let no = 1;

            // BAGIAN I: PG
            if(dataSoal.pg && dataSoal.pg.length > 0) {
                html += `<div class="section-header">I. PILIHAN GANDA</div>`;
                dataSoal.pg.forEach((s, i) => {
                    html += `<div class="soal-card">
                        <span class="number-badge">${no}</span> <b>${s.q}</b>
                        <div style="margin-top:10px;">
                            ${s.opt.map((o, idx) => `
                                <label class="option-label">
                                    <input type="radio" name="pg_${i}" value="${idx}" onchange="simpanJawaban('pg_${i}', ${idx})"> 
                                    <span>${String.fromCharCode(65+idx)}. ${o}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>`;
                    no++;
                });
            }

            // BAGIAN II: ISIAN
            if(dataSoal.isian && dataSoal.isian.length > 0) {
                html += `<div class="section-header">II. ISIAN SINGKAT</div>`;
                dataSoal.isian.forEach((s, i) => {
                    html += `<div class="soal-card">
                        <span class="number-badge">${no}</span> <b>${s}</b><br>
                        <input type="text" id="isian_${i}" class="form-control" placeholder="Ketik jawaban..." oninput="simpanJawaban('isian_${i}', this.value)">
                    </div>`;
                    no++;
                });
            }

            // BAGIAN III: URAIAN
            let labelEssay = (dataSoal.isian && dataSoal.isian.length > 0) ? "III" : "II";
            if(dataSoal.essay && dataSoal.essay.length > 0) {
                html += `<div class="section-header">${labelEssay}. URAIAN</div>`;
                dataSoal.essay.forEach((s, i) => {
                    html += `<div class="soal-card">
                        <span class="number-badge">${no}</span> <b>${s}</b><br>
                        <textarea id="essay_${i}" class="form-control" rows="3" placeholder="Jelaskan jawabanmu..." oninput="simpanJawaban('essay_${i}', this.value)"></textarea>
                    </div>`;
                    no++;
                });
            }

            document.getElementById('box-soal').innerHTML = html;
            window.scrollTo(0, 0);
        }

        // ===========================================
        // 5. FITUR AUTO-SAVE (Simpan ke HP)
        // ===========================================
        
        // Fungsi ini dipanggil setiap kali siswa mengetik/memilih jawaban
        window.simpanJawaban = function(key, val) {
            localStorage.setItem(STORAGE_KEY + key, val);
        }

        // Fungsi ini dipanggil saat halaman dimuat ulang untuk mengisi jawaban lama
        function restoreJawaban() {
            // Restore PG
            if(dataSoal.pg) {
                dataSoal.pg.forEach((_, i) => {
                    const val = localStorage.getItem(STORAGE_KEY + `pg_${i}`);
                    if(val !== null) {
                        const el = document.querySelector(`input[name="pg_${i}"][value="${val}"]`);
                        if(el) el.checked = true;
                    }
                });
            }
            // Restore Isian
            if(dataSoal.isian) {
                dataSoal.isian.forEach((_, i) => {
                    const val = localStorage.getItem(STORAGE_KEY + `isian_${i}`);
                    if(val) document.getElementById(`isian_${i}`).value = val;
                });
            }
            // Restore Essay
            if(dataSoal.essay) {
                dataSoal.essay.forEach((_, i) => {
                    const val = localStorage.getItem(STORAGE_KEY + `essay_${i}`);
                    if(val) document.getElementById(`essay_${i}`).value = val;
                });
            }
        }

        // Hapus data sementara setelah sukses kirim
        function bersihkanData() {
            Object.keys(localStorage).forEach((key) => {
                if(key.startsWith(STORAGE_KEY)) localStorage.removeItem(key);
            });
        }

        // ===========================================
        // 6. TIMER & AUTO-SUBMIT
        // ===========================================
        function jalankanTimer() {
            const display = document.getElementById('time-display');
            const bar = document.getElementById('timer-bar');

            timerInterval = setInterval(() => {
                // Simpan waktu tersisa setiap detik (Agar kalau direfresh, waktu tidak reset)
                localStorage.setItem(STORAGE_KEY + 'waktu', durasiDetik);

                let m = Math.floor(durasiDetik / 60);
                let s = durasiDetik % 60;
                display.innerText = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;

                // Warna Merah jika sisa 5 menit
                if(durasiDetik < 300) {
                    bar.classList.add('critical');
                    bar.innerHTML = `‚ö†Ô∏è WAKTU HABIS SEBENTAR LAGI: ${display.innerText}`;
                }

                // WAKTU HABIS -> KIRIM OTOMATIS
                if(durasiDetik <= 0) {
                    clearInterval(timerInterval);
                    alert("‚è∞ WAKTU HABIS! Jawaban akan dikirim otomatis ke Pak Guru.");
                    prosesSelesai(true);
                }
                durasiDetik--;
            }, 1000);
        }

        window.konfirmasiSelesai = function() {
            if(confirm("Yakin sudah selesai? Jawaban tidak bisa diubah setelah dikirim.")) {
                prosesSelesai(false);
            }
        }

        // ===========================================
        // 7. KIRIM KE FIREBASE
        // ===========================================
        function prosesSelesai(isAuto) {
            clearInterval(timerInterval);
            document.getElementById('timer-bar').style.display = 'none';

            // Hitung Nilai PG
            let benar = 0;
            if(dataSoal.pg) {
                dataSoal.pg.forEach((s, i) => {
                    const el = document.querySelector(`input[name="pg_${i}"]:checked`);
                    if(el && parseInt(el.value) === s.ans) benar++;
                });
            }
            const skor = dataSoal.pg.length > 0 ? Math.round((benar / dataSoal.pg.length) * 100) : 0;

            const dataKirim = {
                nama: document.getElementById('siswa_nama').value,
                kelas: document.getElementById('siswa_kelas').value, 
                sekolah: document.getElementById('siswa_sekolah').value,
                guru: document.getElementById('siswa_guru').value,
                nilai_pg: skor,
                waktu_selesai: new Date().toLocaleString(),
                status: isAuto ? "Otomatis (Waktu Habis)" : "Selesai Manual"
            };

            // Kirim ke Database Kelas 5
            db.ref(`hasil_kuis/kelas_${KELAS}/${bab}/${Date.now()}`).set(dataKirim).then(() => {
                bersihkanData(); // Hapus draft karena sudah dikirim
                document.getElementById('area-soal').style.display = 'none';
                document.getElementById('area-hasil').style.display = 'block';
                document.getElementById('skor-tampil').innerText = skor;
            }).catch(err => {
                alert("Gagal mengirim nilai. Periksa koneksi internet Anda!");
                console.error(err);
            });
        }
    </script>
</body>
</html>