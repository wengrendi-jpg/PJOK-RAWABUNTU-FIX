<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuis PJOK - SDN Rawabuntu 03</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body{font-family:'Nunito',sans-serif;background:#e3f2fd;margin:0;padding:20px;color:#333}
        .container{max-width:600px;margin:auto;background:white;padding:25px;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,0.1)}
        h2, h3{text-align:center;color:#e91e63;margin-bottom:20px}
        
        .input-group{margin-bottom:15px}
        .input-group label{display:block;margin-bottom:5px;font-weight:700;font-size:14px}
        .form-control{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-family:inherit;box-sizing:border-box}
        .section-header{background:#0288d1;color:white;padding:10px 15px;border-radius:8px;margin:25px 0 15px;font-weight:800}
        .soal-card{background:#f9fbe7;border:1px solid #dce775;padding:15px;border-radius:10px;margin-bottom:15px}
        .soal-text{font-weight:700;margin-bottom:10px;display:block}
        
        .option-label{display:block;padding:10px;background:white;border:1px solid #ddd;border-radius:8px;margin-bottom:5px;cursor:pointer;transition:0.2s}
        .option-label:hover{background:#e1f5fe;border-color:#29b6f6}
        input[type="radio"]{margin-right:10px}

        .btn{width:100%;padding:14px;border:none;border-radius:50px;font-weight:800;font-size:16px;cursor:pointer;margin-top:20px;color:white}
        .btn-start{background:#e91e63}
        .btn-submit{background:#43a047}
        .btn-back{background:#757575}

        #loading-overlay, #hasil-area {display:none;text-align:center}
        .score-circle{width:120px;height:120px;background:#e91e63;color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:40px;font-weight:800;margin:0 auto 20px}
    </style>
</head>
<body>

<div class="container">
    <div id="form-identitas">
        <h2>üìã DATA SISWA</h2>
        <div class="input-group">
            <label>Nama Lengkap</label>
            <input type="text" id="inputNama" class="form-control" placeholder="Nama Lengkap...">
        </div>
        <div class="input-group">
            <label>Kelas</label>
            <select id="inputKelas" class="form-control">
                <option value="">-- Pilih Kelas --</option>
                <option value="1A">1A</option><option value="1B">1B</option><option value="1C">1C</option>
                <option value="1D">1D</option><option value="1E">1E</option>
            </select>
        </div>
        <button class="btn btn-start" onclick="mulaiKuis()">üöÄ MULAI MENGERJAKAN</button>
    </div>

    <div id="lembar-kuis" style="display:none;">
        <h3 id="judul-kuis">Soal PJOK</h3>
        <div id="container-soal"></div>
        <button class="btn btn-submit" onclick="hitungDanKirim()">‚úÖ KIRIM JAWABAN</button>
    </div>

    <div id="hasil-area">
        <h2>üéâ SELESAI!</h2>
        <p>Nilai Kamu:</p>
        <div class="score-circle" id="skor-akhir">0</div>
        <p>Nilai sudah dikirim ke Pak Rendi.</p>
        <a href="materi-kelas-1.html" class="btn btn-back" style="display:block; text-decoration:none; text-align:center;">üè† KEMBALI</a>
    </div>
</div>

<script>
    // --- DATABASE SOAL (KUNCI JAWABAN: 0=A, 1=B, 2=C) ---
    const BANK_SOAL = {
        "A": { 
            pg: [
                {q:"Berjalan adalah gerakan berpindah tempat. Disebut gerak...", opt:["Lokomotor","Non-lokomotor","Manipulatif"], ans:0}, 
                {q:"Posisi badan saat berjalan harus...", opt:["Membungkuk","Tegak","Miring"], ans:1},
                {q:"Pandangan mata saat berjalan ke arah...", opt:["Bawah","Depan","Atas"], ans:1},
                {q:"Berjalan melatih otot...", opt:["Tangan","Leher","Kaki"], ans:2},
                {q:"Lari lebih ... daripada jalan.", opt:["Lambat","Cepat","Sama"], ans:1}
            ]
        },
        "STS": {
            pg: [
                {q:"Gerak meniru hewan berjalan termasuk gerak...", opt:["Lokomotor","Non","Diam"], ans:0},
                {q:"Gerak berpindah tempat disebut...", opt:["Lokomotor","Non","Manipulatif"], ans:0},
                {q:"Gambar anak melompat katak meniru hewan...", opt:["Kucing","Katak","Ular"], ans:1},
                {q:"Jalan ke depan melatih otot...", opt:["Tangan","Kaki","Leher"], ans:1},
                {q:"Saat lari kaki melangkah...", opt:["Lambat","Cepat","Diam"], ans:1}
            ]
        },
        "SAS": { pg: [{q:"Sikap duduk benar...", opt:["Bungkuk","Tegak","Miring"], ans:1}] }
    };
    
    // Fallback: Copy soal A ke bab lain biar gak error
    ['B','C','D','E','F','G','H'].forEach(b => { if(!BANK_SOAL[b]) BANK_SOAL[b] = BANK_SOAL['A']; });

    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyD7FsbgyUF1jvDvcrb6wrWlEiQJUFZG3kE",
        authDomain: "pjok-sekolah-bapak-rendi.firebaseapp.com",
        databaseURL: "https://pjok-sekolah-bapak-rendi-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "pjok-sekolah-bapak-rendi",
        appId: "1:337016584526:web:8534c7cf4012a35427861f"
    };

    let database;
    let currentBab = 'A';
    let currentSoal = null;

    document.addEventListener('DOMContentLoaded', () => {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        database = firebase.database();

        const urlParams = new URLSearchParams(window.location.search);
        currentBab = urlParams.get('bab') || 'A';
        currentSoal = BANK_SOAL[currentBab] || BANK_SOAL['A'];
        
        document.getElementById('judul-kuis').innerText = `Kuis Bab ${currentBab}`;

        // Auto-fill nama jika ada
        if(localStorage.getItem('siswa_nama')) document.getElementById('inputNama').value = localStorage.getItem('siswa_nama');
        if(localStorage.getItem('siswa_kelas')) document.getElementById('inputKelas').value = localStorage.getItem('siswa_kelas');
    });

    function mulaiKuis() {
        const nama = document.getElementById('inputNama').value;
        const kelas = document.getElementById('inputKelas').value;
        if (!nama || !kelas) { alert("Isi Nama & Kelas dulu ya!"); return; }

        localStorage.setItem('siswa_nama', nama);
        localStorage.setItem('siswa_kelas', kelas);

        document.getElementById('form-identitas').style.display = 'none';
        document.getElementById('lembar-kuis').style.display = 'block';
        renderSoal();
    }

    function renderSoal() {
        const container = document.getElementById('container-soal');
        let html = '';

        if (currentSoal.pg) {
            html += `<div class="section-header">PILIHAN GANDA</div>`;
            currentSoal.pg.forEach((item, idx) => {
                html += `
                <div class="soal-card">
                    <span class="soal-text">${idx+1}. ${item.q}</span>
                    ${item.opt.map((opt, i) => `
                        <label class="option-label">
                            <input type="radio" name="pg_${idx}" value="${i}"> 
                            ${String.fromCharCode(65+i)}. ${opt}
                        </label>
                    `).join('')}
                </div>`;
            });
        }
        container.innerHTML = html;
        window.scrollTo(0,0);
    }

    // --- LOGIKA HITUNG NILAI (PERBAIKAN UTAMA) ---
    window.hitungDanKirim = function() {
        const btn = document.querySelector('.btn-submit');
        
        let benar = 0;
        let total = currentSoal.pg ? currentSoal.pg.length : 0;

        // Cek Jawaban
        if (currentSoal.pg) {
            currentSoal.pg.forEach((item, idx) => {
                const radios = document.getElementsByName(`pg_${idx}`);
                let dijawab = false;
                for(let r of radios) {
                    if(r.checked) {
                        dijawab = true;
                        // PERBAIKAN: Gunakan '==' biar string "0" dianggap sama dengan angka 0
                        if(r.value == item.ans) { 
                            benar++;
                        }
                    }
                }
            });
        }

        // Hitung Skor (0-100)
        let nilaiAkhir = total > 0 ? Math.round((benar / total) * 100) : 0;

        // DEBUG: Munculkan alert agar Bapak tahu nilainya benar sebelum dikirim
        let konfirmasi = confirm(`Kamu menjawab BENAR ${benar} dari ${total} soal.\nNilai Kamu: ${nilaiAkhir}\n\nKirim sekarang?`);
        
        if(!konfirmasi) return;

        // Kunci Tombol
        btn.innerHTML = "‚è≥ Mengirim ke Server...";
        btn.disabled = true;

        const dataKirim = {
            nama: localStorage.getItem('siswa_nama'),
            kelas: localStorage.getItem('siswa_kelas'),
            nilai_pg: nilaiAkhir,
            waktu: new Date().toLocaleString()
        };

        // Kirim ke Firebase
        database.ref(`hasil_kuis/kelas_1/${currentBab}`).push(dataKirim)
            .then(() => {
                document.getElementById('lembar-kuis').style.display = 'none';
                document.getElementById('hasil-area').style.display = 'block';
                document.getElementById('skor-akhir').innerText = nilaiAkhir;
            })
            .catch((error) => {
                alert("GAGAL KIRIM: " + error.message + "\n\nCoba cek koneksi internet!");
                btn.innerHTML = "‚úÖ KIRIM JAWABAN";
                btn.disabled = false;
            });
    }
</script>
</body>
</html>