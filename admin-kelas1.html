<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Kontrol Kelas 1 - Admin PJOK</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #e8f5e9; margin: 0; padding: 20px; color: #333; }
        
        /* HEADER HIJAU */
        .header {
            background: #43a047; /* Hijau Tua */
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-bottom: 25px;
        }
        .header-title { font-size: 20px; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        
        .btn-group { display: flex; gap: 10px; }
        .btn { padding: 8px 15px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; text-decoration: none; font-size: 13px; display: flex; align-items: center; gap: 5px; transition: 0.3s; }
        
        .btn-excel { background: #1976d2; color: white; } /* Biru */
        .btn-reset { background: #d32f2f; color: white; } /* Merah */
        .btn-menu { background: white; color: #43a047; } /* Putih */
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }

        /* SECTION CARD */
        .section-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            border-left: 5px solid #43a047;
        }
        .section-title {
            color: #2e7d32;
            font-weight: 800;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            border-bottom: 1px dashed #a5d6a7;
            padding-bottom: 10px;
        }

        /* GRID SWITCH KONTROL */
        .switch-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
        }
        .switch-box {
            background: #f1f8e9;
            border: 1px solid #c8e6c9;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: 0.3s;
        }
        .switch-box:hover { background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .bab-label { font-weight: 800; color: #333; font-size: 14px; margin-bottom: 10px; display: block; }
        
        /* TOGGLE STYLE */
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #43a047; }
        input:checked + .slider:before { transform: translateX(24px); }
        .status-text { font-size: 10px; display: block; margin-top: 5px; color: #666; font-weight: bold; }

        /* FILTER & SEARCH */
        .filter-area { display: flex; gap: 15px; margin-bottom: 15px; }
        .input-control { padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%; outline: none; }
        .input-control:focus { border-color: #43a047; }

        /* TABEL NILAI HIJAU */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 1000px; }
        thead { background: #43a047; color: white; }
        th { padding: 12px 8px; text-align: center; border: 1px solid #388e3c; }
        td { padding: 8px; border: 1px solid #eee; text-align: center; color: #444; }
        tr:nth-child(even) { background: #f9f9f9; }
        tr:hover { background: #e8f5e9; }
        
        /* Highlight Kolom Rata-rata */
        .col-rata { background: #1b5e20; color: #fff; font-weight: bold; }
        .td-rata { background: #e8f5e9; font-weight: bold; color: #1b5e20; }
        .btn-del { background: #ffcdd2; color: #c62828; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .btn-del:hover { background: #c62828; color: white; }

        /* Responsive */
        @media(max-width: 768px) { .header { flex-direction: column; gap: 10px; } .filter-area { flex-direction: column; } }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-title">üìã PANEL KONTROL KELAS 1</div>
        <div class="btn-group">
            <button class="btn btn-excel" onclick="exportTableToExcel()">üìä Download Excel</button>
            <button class="btn btn-reset" onclick="resetSemuaData()">üóëÔ∏è Reset Total</button>
            <a href="dashboard.html" class="btn btn-menu">üè† Menu Utama</a>
        </div>
    </div>

    <div class="section-card">
        <div class="section-title">üîì BUKA / TUTUP AKSES SOAL (KELAS 1)</div>
        <div class="switch-grid" id="switch-container">
            <p>Memuat kontrol...</p>
        </div>
    </div>

    <div class="section-card">
        <div class="section-title">üìà REKAP NILAI SISWA (LENGKAP SEMESTER 1 & 2)</div>
        
        <div class="filter-area">
            <input type="text" id="cariNama" class="input-control" placeholder="Cari Nama Siswa..." onkeyup="filterTabel()">
            <select id="cariKelas" class="input-control" onchange="filterTabel()">
                <option value="">Semua Kelas</option>
                <option value="1A">Kelas 1A</option>
                <option value="1B">Kelas 1B</option>
                <option value="1C">Kelas 1C</option>
            </select>
        </div>

        <div class="table-container">
            <table id="tabel-rekap">
                <thead>
                    <tr>
                        <th rowspan="2">Nama Siswa</th>
                        <th rowspan="2">Kelas</th>
                        <th colspan="5">SEMESTER 1</th>
                        <th rowspan="2" class="col-rata">RATA SMT 1</th>
                        <th colspan="5">SEMESTER 2</th>
                        <th rowspan="2" class="col-rata">RATA SMT 2</th>
                        <th rowspan="2">Aksi</th>
                    </tr>
                    <tr>
                        <th width="40">A</th> <th width="40">B</th> <th width="40">C</th> <th width="40">D</th> <th width="40">STS</th>
                        <th width="40">E</th> <th width="40">F</th> <th width="40">G</th> <th width="40">H</th> <th width="40">SAS</th>
                    </tr>
                </thead>
                <tbody id="body-nilai">
                    <tr><td colspan="15" style="padding:20px;">‚è≥ Sedang mengambil data dari server...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // 1. CONFIG FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyD7FsbgyUF1jvDvcrb6wrWlEiQJUFZG3kE",
            authDomain: "pjok-sekolah-bapak-rendi.firebaseapp.com",
            databaseURL: "https://pjok-sekolah-bapak-rendi-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pjok-sekolah-bapak-rendi",
            appId: "1:337016584526:web:8534c7cf4012a35427861f"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const daftarBab = ['A', 'B', 'C', 'D', 'STS', 'E', 'F', 'G', 'H', 'SAS'];

        // 2. GENERATE SWITCH (KONTROL SOAL)
        function initSwitch() {
            const container = document.getElementById('switch-container');
            container.innerHTML = '';
            
            daftarBab.forEach(bab => {
                const box = document.createElement('div');
                box.className = 'switch-box';
                box.innerHTML = `
                    <span class="bab-label">BAB ${bab}</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="chk-${bab}" onchange="updateAkses('${bab}', this.checked)">
                        <span class="slider"></span>
                    </label>
                    <span class="status-text" id="txt-${bab}">TERKUNCI</span>
                `;
                container.appendChild(box);

                // Live Listen Firebase
                database.ref(`akses_soal/kelas_1/${bab}`).on('value', (snap) => {
                    const isOpen = snap.val() === true;
                    document.getElementById(`chk-${bab}`).checked = isOpen;
                    document.getElementById(`txt-${bab}`).innerText = isOpen ? "TERBUKA" : "TERKUNCI";
                    document.getElementById(`txt-${bab}`).style.color = isOpen ? "#2ecc71" : "#999";
                });
            });
        }

        function updateAkses(bab, status) {
            database.ref(`akses_soal/kelas_1/${bab}`).set(status);
        }

        // 3. LOAD & OLAH DATA NILAI (SISTEM REKAP PINTAR)
        function loadDataNilai() {
            database.ref('hasil_kuis/kelas_1').on('value', (snap) => {
                const rawData = snap.val();
                const tbody = document.getElementById('body-nilai');
                tbody.innerHTML = '';

                if(!rawData) {
                    tbody.innerHTML = '<tr><td colspan="15" style="padding:20px;">Belum ada data nilai masuk.</td></tr>';
                    return;
                }

                // Struktur Data Sementara: { "Nama_Kelas": { nama: "Budi", kelas: "1A", A: 90, B: 80, ... } }
                let rekapSiswa = {};

                // Loop per BAB (A, B, C...)
                Object.keys(rawData).forEach(bab => {
                    const dataBab = rawData[bab];
                    Object.keys(dataBab).forEach(uid => { // UID bisa berupa kombinasi nama
                        const dataSiswa = dataBab[uid];
                        const keyUnik = dataSiswa.nama + "_" + dataSiswa.kelas; // Kunci unik Nama+Kelas

                        if(!rekapSiswa[keyUnik]) {
                            rekapSiswa[keyUnik] = { 
                                nama: dataSiswa.nama, 
                                kelas: dataSiswa.kelas,
                                nilai: {} 
                            };
                        }
                        // Masukkan nilai ke bab yg sesuai
                        rekapSiswa[keyUnik].nilai[bab] = dataSiswa.nilai_pg; 
                    });
                });

                // Render ke Tabel
                Object.values(rekapSiswa).sort((a,b) => a.kelas.localeCompare(b.kelas)).forEach(siswa => {
                    // Hitung Rata SMT 1 (A,B,C,D,STS)
                    let sum1 = 0, count1 = 0;
                    ['A','B','C','D','STS'].forEach(k => { if(siswa.nilai[k]) { sum1 += parseInt(siswa.nilai[k]); count1++; } });
                    let rata1 = count1 > 0 ? Math.round(sum1/count1) : "-";

                    // Hitung Rata SMT 2 (E,F,G,H,SAS)
                    let sum2 = 0, count2 = 0;
                    ['E','F','G','H','SAS'].forEach(k => { if(siswa.nilai[k]) { sum2 += parseInt(siswa.nilai[k]); count2++; } });
                    let rata2 = count2 > 0 ? Math.round(sum2/count2) : "-";

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="text-align:left; font-weight:bold;">${siswa.nama}</td>
                        <td>${siswa.kelas}</td>
                        
                        <td>${siswa.nilai['A'] || '-'}</td>
                        <td>${siswa.nilai['B'] || '-'}</td>
                        <td>${siswa.nilai['C'] || '-'}</td>
                        <td>${siswa.nilai['D'] || '-'}</td>
                        <td>${siswa.nilai['STS'] || '-'}</td>
                        <td class="td-rata">${rata1}</td>

                        <td>${siswa.nilai['E'] || '-'}</td>
                        <td>${siswa.nilai['F'] || '-'}</td>
                        <td>${siswa.nilai['G'] || '-'}</td>
                        <td>${siswa.nilai['H'] || '-'}</td>
                        <td>${siswa.nilai['SAS'] || '-'}</td>
                        <td class="td-rata">${rata2}</td>

                        <td>
                            <button class="btn-del" onclick="hapusSiswa('${siswa.nama}', '${siswa.kelas}')">‚ùå Hapus</button>    
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        // Hapus Data Siswa (Semua Bab)
        window.hapusSiswa = function(nama, kelas) {
            if(!confirm(`Yakin ingin menghapus semua nilai milik ${nama} (${kelas})? Data tidak bisa kembali.`)) return;

            // Loop hapus di setiap bab
            daftarBab.forEach(bab => {
                // Kita harus cari key-nya dulu (karena key firebase unik)
                // Ini cara sederhana: fetch dulu lalu hapus yg namanya cocok
                database.ref(`hasil_kuis/kelas_1/${bab}`).once('value', snap => {
                    snap.forEach(child => {
                        if(child.val().nama === nama && child.val().kelas === kelas) {
                            database.ref(`hasil_kuis/kelas_1/${bab}/${child.key}`).remove();
                        }
                    });
                });
            });
            alert("Data sedang dihapus...");
        };

        // Reset Total (Bahaya)
        window.resetSemuaData = function() {
            const code = prompt("Ketik 'RESET' untuk menghapus SELURUH NILAI siswa kelas 1:");
            if(code === 'RESET') {
                database.ref('hasil_kuis/kelas_1').remove();
                alert("Semua data nilai berhasil dikosongkan.");
            }
        };

        // Filter Tabel (Cari Nama/Kelas)
        window.filterTabel = function() {
            const namaFilter = document.getElementById('cariNama').value.toLowerCase();
            const kelasFilter = document.getElementById('cariKelas').value;
            const rows = document.querySelectorAll('#body-nilai tr');

            rows.forEach(row => {
                const nama = row.cells[0].innerText.toLowerCase();
                const kelas = row.cells[1].innerText;
                const matchNama = nama.includes(namaFilter);
                const matchKelas = kelasFilter === "" || kelas === kelasFilter;

                row.style.display = (matchNama && matchKelas) ? '' : 'none';
            });
        };

        // Export Excel
        window.exportTableToExcel = function() {
            const table = document.getElementById("tabel-rekap");
            const wb = XLSX.utils.table_to_book(table, {sheet: "Rekap Nilai"});
            XLSX.writeFile(wb, "Rekap_Nilai_PJOK_Kelas1.xlsx");
        }

        // Jalankan saat load
        window.onload = function() {
            initSwitch();
            loadDataNilai();
        };
    </script>
</body>
</html>