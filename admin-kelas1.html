<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - PJOK Kelas 1</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Nunito', sans-serif; background: #fce4ec; margin: 0; padding: 20px; color: #333; }
        
        /* HEADER STYLE */
        .header { background: linear-gradient(135deg, #d81b60, #ec407a); color: white; padding: 15px 20px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(233,30,99,0.3); }
        .header h2 { margin: 0; font-size: 20px; font-weight: 800; }
        
        .btn-group { display: flex; gap: 10px; }
        .btn-action { padding: 10px 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 13px; color: white; display: flex; align-items: center; gap: 5px; transition: 0.2s; text-decoration: none; }
        .btn-action:hover { transform: translateY(-2px); opacity: 0.9; }
        
        /* WARNA TOMBOL */
        .btn-excel { background: #43a047; } 
        .btn-reset { background: #b71c1c; } 
        .btn-menu { background: #fff; color: #d81b60; }
        
        /* CARD STYLE */
        .panel-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 25px; position: relative; overflow: hidden; }
        .panel-card::before { content: ''; position: absolute; top: 0; left: 0; width: 6px; height: 100%; background: #ec407a; }
        .card-title { font-weight: 800; font-size: 16px; margin-bottom: 20px; display: block; border-bottom: 2px dashed #f8bbd0; padding-bottom: 10px; color: #880e4f; }

        /* SAKLAR TOGGLE */
        .switch-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }
        .switch-item { background: #fff0f5; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #fce4ec; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; margin: 10px 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #e91e63; }
        input:checked + .slider:before { transform: translateX(24px); }
        .status-text { font-size: 11px; font-weight: 800; display: block; margin-top: 5px;}

        /* TABEL NILAI */
        .filter-group { display: flex; gap: 10px; margin-bottom: 15px; background: #fce4ec; padding: 10px; border-radius: 10px; flex-wrap: wrap; }
        .filter-input { padding: 10px; border: 1px solid #f48fb1; border-radius: 8px; font-family: 'Nunito'; outline: none; min-width: 200px; }
        
        .table-responsive { overflow-x: auto; border-radius: 10px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; background: white; white-space: nowrap; }
        th { background: #f06292; color: white; padding: 12px 10px; text-align: center; border: 1px solid #f8bbd0; }
        td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; border-right: 1px solid #eee; }
        tr:hover { background-color: #fff8e1; }
        
        .nilai-box { font-weight: bold; color: #d81b60; }
        .nilai-kosong { color: #ccc; font-size: 20px; }
        .nilai-total { background: #fce4ec; color: #880e4f; font-weight: 800; border: 2px solid #f8bbd0; padding: 5px 10px; border-radius: 20px; }

        /* Tombol Hapus Kecil */
        .btn-del-mini { background: #ffcdd2; color: #c62828; border: 1px solid #ef5350; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 11px; font-weight: bold; }
        .btn-del-mini:hover { background: #c62828; color: white; }
    </style>
</head>
<body>

    <div class="header">
        <h2>üéõÔ∏è PANEL KONTROL KELAS 1</h2>
        <div class="btn-group">
            <button onclick="downloadExcel()" class="btn-action btn-excel">üìä Download Excel</button>
            <button onclick="resetSemuaData()" class="btn-action btn-reset">üóëÔ∏è Reset Total</button>
            <a href="../../index.html" class="btn-action btn-menu">üè† Menu Utama</a>
        </div>
    </div>

    <div class="panel-card">
        <span class="card-title">üîí BUKA / TUTUP AKSES SOAL</span>
        <div class="switch-grid" id="container-switches"></div>
    </div>

    <div class="panel-card">
        <span class="card-title">üìù REKAP NILAI SISWA (70% Harian + 30% Ujian)</span>
        
        <div class="filter-group">
            <input type="text" id="filterSekolah" class="filter-input" placeholder="Cari Asal Sekolah..." onkeyup="renderTabel()">
            <select id="filterKelas" class="filter-input" onchange="renderTabel()">
                <option value="">Semua Kelas</option>
                <option value="1A">Kelas 1A</option>
                <option value="1B">Kelas 1B</option>
                <option value="1C">Kelas 1C</option>
                <option value="1D">Kelas 1D</option>
                <option value="1E">Kelas 1E</option>
            </select>
        </div>

        <div class="table-responsive">
            <table id="tabel-nilai">
                <thead>
                    <tr>
                        <th style="text-align:left; padding-left:15px; min-width:150px;">Nama Siswa</th>
                        <th>Kelas</th>
                        <th>Guru PJOK</th>
                        <th>Asal Sekolah</th>
                        
                        <th>A</th> <th>B</th> <th>C</th> <th>D</th> 
                        <th style="background:#ad1457;">STS</th>
                        <th style="background:#880e4f; color:#fff4b4;">RATA SMT 1</th> 
                        
                        <th>E</th> <th>F</th> <th>G</th> <th>H</th>
                        <th style="background:#ad1457;">SAS</th>
                        <th style="background:#880e4f; color:#fff4b4;">RATA SMT 2</th>

                        <th class="no-print">Aksi</th>
                    </tr>
                </thead>
                <tbody id="body-nilai">
                    <tr><td colspan="17">Memuat data dari server...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // 1. KONFIGURASI FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyD7FsbgyUF1jvDvcrb6wrWlEiQJUFZG3kE",
            authDomain: "pjok-sekolah-bapak-rendi.firebaseapp.com",
            databaseURL: "https://pjok-sekolah-bapak-rendi-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pjok-sekolah-bapak-rendi",
            appId: "1:337016584526:web:8534c7cf4012a35427861f"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        // PEMBAGIAN BAB SEMESTER
        const listBab = ['A', 'B', 'C', 'D', 'STS', 'E', 'F', 'G', 'H', 'SAS'];
        
        // Harian Sem 1 (A,B,C,D) dan Ujian Sem 1 (STS)
        const harian1 = ['A', 'B', 'C', 'D'];
        const ujian1 = 'STS';

        // Harian Sem 2 (E,F,G,H) dan Ujian Sem 2 (SAS)
        const harian2 = ['E', 'F', 'G', 'H'];
        const ujian2 = 'SAS';

        let rawDataKuis = {}; 

        // 2. RENDER AWAL
        document.addEventListener('DOMContentLoaded', () => {
            // A. Tombol Saklar
            const container = document.getElementById('container-switches');
            listBab.forEach(bab => {
                container.innerHTML += `
                    <div class="switch-item">
                        <div style="font-weight:bold; margin-bottom:5px;">BAB ${bab}</div>
                        <label class="switch">
                            <input type="checkbox" id="toggle-${bab}" onchange="updateAkses('${bab}')">
                            <span class="slider"></span>
                        </label>
                        <span class="status-text" id="status-${bab}">...</span>
                    </div>
                `;
            });

            // Monitor Saklar
            db.ref('akses_soal/kelas_1').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                listBab.forEach(bab => {
                    const isOpen = data[bab] === true;
                    const toggle = document.getElementById(`toggle-${bab}`);
                    const text = document.getElementById(`status-${bab}`);
                    if(toggle) {
                        toggle.checked = isOpen;
                        text.innerText = isOpen ? "TERBUKA" : "TERKUNCI";
                        text.style.color = isOpen ? "#e91e63" : "#999";
                    }
                });
            });

            // Monitor Nilai
            db.ref('hasil_kuis/kelas_1').on('value', (snapshot) => {
                rawDataKuis = snapshot.val() || {};
                renderTabel();
            });
        });

        // 3. FUNGSI SAKLAR
        window.updateAkses = function(bab) {
            const toggle = document.getElementById(`toggle-${bab}`);
            db.ref(`akses_soal/kelas_1/${bab}`).set(toggle.checked).catch(e => alert(e.message));
        };

        // 4. FUNGSI HITUNG NILAI AKHIR (BOBOT 70% : 30%)
        function hitungNilaiAkhir(siswa, babHarian, babUjian) {
            // A. Hitung Rata-rata Harian (70%)
            let totalHarian = 0;
            let countHarian = 0;

            babHarian.forEach(bab => {
                if (siswa.dataNilai[bab] !== undefined) {
                    totalHarian += parseInt(siswa.dataNilai[bab]);
                    countHarian++;
                }
            });

            const rataHarian = countHarian > 0 ? (totalHarian / countHarian) : 0;

            // B. Ambil Nilai Ujian (30%)
            const nilaiUjian = siswa.dataNilai[babUjian] !== undefined ? parseInt(siswa.dataNilai[babUjian]) : 0;
            const adaUjian = siswa.dataNilai[babUjian] !== undefined;

            // C. LOGIKA PEMBOBOTAN
            // 1. Belum ada nilai sama sekali
            if (countHarian === 0 && !adaUjian) {
                return "-";
            }

            // 2. Ada Harian, Belum Ujian -> Pakai Rata Harian Murni
            if (countHarian > 0 && !adaUjian) {
                return Math.round(rataHarian);
            }

            // 3. Belum Harian, Cuma Ujian -> Pakai Nilai Ujian Murni
            if (countHarian === 0 && adaUjian) {
                return nilaiUjian;
            }

            // 4. LENGKAP (Ada Harian & Ujian) -> Pakai Rumus Bobot
            const nilaiAkhir = (rataHarian * 0.7) + (nilaiUjian * 0.3);
            return Math.round(nilaiAkhir);
        }

        // 5. FUNGSI RENDER TABEL
        function renderTabel() {
            const tbody = document.getElementById('body-nilai');
            tbody.innerHTML = '';

            const cariSekolah = document.getElementById('filterSekolah').value.toLowerCase();
            const cariKelas = document.getElementById('filterKelas').value;

            let rekapSiswa = {};

            // Pivot Data
            Object.keys(rawDataKuis).forEach(bab => {
                const dataBab = rawDataKuis[bab];
                if(dataBab) {
                    Object.keys(dataBab).forEach(uid => {
                        const s = dataBab[uid];
                        const uniqueKey = (s.nama + s.kelas).toLowerCase().replace(/\s/g, '');

                        if(!rekapSiswa[uniqueKey]) {
                            rekapSiswa[uniqueKey] = {
                                nama: s.nama,
                                kelas: s.kelas,
                                guru: s.guru || '-',
                                sekolah: s.sekolah || '-',
                                dataNilai: {}
                            };
                        }
                        rekapSiswa[uniqueKey].dataNilai[bab] = s.nilai_pg;
                    });
                }
            });

            let arrSiswa = Object.values(rekapSiswa);
            
            // Filter
            arrSiswa = arrSiswa.filter(s => {
                const matchSekolah = s.sekolah.toLowerCase().includes(cariSekolah);
                const matchKelas = cariKelas === "" || s.kelas === cariKelas;
                return matchSekolah && matchKelas;
            });

            arrSiswa.sort((a, b) => a.sekolah.localeCompare(b.sekolah) || a.kelas.localeCompare(b.kelas) || a.nama.localeCompare(b.nama));

            if(arrSiswa.length === 0) {
                tbody.innerHTML = '<tr><td colspan="17" style="padding:20px;">Data tidak ditemukan.</td></tr>';
                return;
            }

            arrSiswa.forEach(siswa => {
                let rowHTML = `
                    <tr>
                        <td style="text-align:left; font-weight:bold;">${siswa.nama}</td>
                        <td><span style="background:#eee; padding:2px 8px; border-radius:4px;">${siswa.kelas}</span></td>
                        <td>${siswa.guru}</td>
                        <td>${siswa.sekolah}</td>
                `;

                // --- SEMESTER 1 ---
                harian1.forEach(bab => {
                    const nilai = siswa.dataNilai[bab];
                    if(nilai !== undefined) {
                        const color = nilai < 75 ? '#d32f2f' : '#2e7d32';
                        rowHTML += `<td><span class="nilai-box" style="color:${color}">${nilai}</span></td>`;
                    } else {
                        rowHTML += `<td><span class="nilai-kosong">-</span></td>`;
                    }
                });
                
                // Nilai STS
                const nSTS = siswa.dataNilai[ujian1];
                const cSTS = (nSTS !== undefined && nSTS < 75) ? '#d32f2f' : '#2e7d32';
                rowHTML += `<td><span class="nilai-box" style="color:${nSTS !== undefined ? cSTS : '#ccc'}">${nSTS !== undefined ? nSTS : '-'}</span></td>`;

                // TOTAL RATA SMT 1 (Bobot)
                const rata1 = hitungNilaiAkhir(siswa, harian1, ujian1);
                const warna1 = (rata1 !== "-" && rata1 < 75) ? '#d32f2f' : '#880e4f';
                rowHTML += `<td><span class="nilai-total" style="color:${warna1}">${rata1}</span></td>`;


                // --- SEMESTER 2 ---
                harian2.forEach(bab => {
                    const nilai = siswa.dataNilai[bab];
                    if(nilai !== undefined) {
                        const color = nilai < 75 ? '#d32f2f' : '#2e7d32';
                        rowHTML += `<td><span class="nilai-box" style="color:${color}">${nilai}</span></td>`;
                    } else {
                        rowHTML += `<td><span class="nilai-kosong">-</span></td>`;
                    }
                });

                // Nilai SAS
                const nSAS = siswa.dataNilai[ujian2];
                const cSAS = (nSAS !== undefined && nSAS < 75) ? '#d32f2f' : '#2e7d32';
                rowHTML += `<td><span class="nilai-box" style="color:${nSAS !== undefined ? cSAS : '#ccc'}">${nSAS !== undefined ? nSAS : '-'}</span></td>`;

                // TOTAL RATA SMT 2 (Bobot)
                const rata2 = hitungNilaiAkhir(siswa, harian2, ujian2);
                const warna2 = (rata2 !== "-" && rata2 < 75) ? '#d32f2f' : '#880e4f';
                rowHTML += `<td><span class="nilai-total" style="color:${warna2}">${rata2}</span></td>`;

                // TOMBOL HAPUS
                rowHTML += `
                    <td class="no-print">
                        <button class="btn-del-mini" onclick="hapusSiswa('${siswa.nama}', '${siswa.kelas}')">‚ùå Hapus</button>
                    </td>
                </tr>`;
                
                tbody.innerHTML += rowHTML;
            });
        }

        // 6. HAPUS PERORANG
        window.hapusSiswa = function(nama, kelas) {
            if(!confirm(`‚ö†Ô∏è Hapus data: ${nama} (${kelas})?\nData akan hilang permanen.`)) return;
            const updates = {};
            let count = 0;
            Object.keys(rawDataKuis).forEach(bab => {
                const dataBab = rawDataKuis[bab];
                if(dataBab) {
                    Object.keys(dataBab).forEach(uid => {
                        const s = dataBab[uid];
                        if(s.nama === nama && s.kelas === kelas) {
                            updates[`hasil_kuis/kelas_1/${bab}/${uid}`] = null;
                            count++;
                        }
                    });
                }
            });
            if(count > 0) {
                db.ref().update(updates).then(() => alert("‚úÖ Data dihapus.")).catch(e => alert(e.message));
            } else {
                alert("Data tidak ditemukan.");
            }
        };

        // 7. RESET TOTAL
        window.resetSemuaData = function() {
            const code = prompt("‚ö†Ô∏è PERINGATAN!\n\nMenghapus SELURUH data Kelas 1.\nKetik 'SETUJU' untuk melanjutkan:");
            if(code === "SETUJU") {
                db.ref('hasil_kuis/kelas_1').remove().then(() => alert("‚úÖ Data dikosongkan.")).catch(e => alert(e.message));
            }
        };

        // 8. DOWNLOAD EXCEL
        window.downloadExcel = function() {
            const table = document.getElementById("tabel-nilai");
            const tempTable = table.cloneNode(true);
            tempTable.querySelectorAll('.no-print').forEach(e => e.remove());
            const wb = XLSX.utils.table_to_book(tempTable, {sheet: "Rekap Nilai"});
            XLSX.writeFile(wb, "Rekap_Nilai_PJOK_Kelas1.xlsx");
        }
    </script>
</body>
</html>