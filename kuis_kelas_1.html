<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuis PJOK Kelas 1</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script src="bank_soal_1.js"></script>
    
    <style>
        body { font-family: 'Nunito', sans-serif; background: #ffebee; margin: 0; padding: 0; color: #333; padding-bottom: 50px; }
        
        /* TIMER MELAYANG */
        .timer-bar { 
            position: fixed; top: 0; left: 0; right: 0; 
            background: #d32f2f; color: white; padding: 15px; 
            text-align: center; font-size: 18px; font-weight: 800; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1000; 
            display: none; 
        }
        
        .container { 
            max-width: 800px; margin: 80px auto 20px; 
            background: white; padding: 30px; border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 8px solid #e53935; 
        }
        
        .section-header { background: #e53935; color: white; padding: 12px; border-radius: 8px; margin: 30px 0 15px; font-weight: 800; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; text-align: center; }
        
        .soal-card { background: #fffdea; border: 1px solid #ef9a9a; padding: 20px; border-radius: 12px; margin-bottom: 20px; position: relative; }
        .number-badge { background: #c62828; color: white; padding: 5px 12px; border-radius: 8px; font-weight: 800; margin-right: 10px; font-size: 14px; }
        
        .option-label { display: block; padding: 12px 15px; background: white; border: 2px solid #ef9a9a; border-radius: 10px; margin-top: 10px; cursor: pointer; transition: 0.2s; font-weight: 600; }
        .option-label:hover { background: #ffebee; border-color: #c62828; }
        input[type="radio"]:checked + span { font-weight: bold; color: #d32f2f; }
        input[type="radio"] { margin-right: 10px; transform: scale(1.2); }
        
        .form-control { width: 100%; padding: 12px; border: 2px solid #ef9a9a; border-radius: 10px; font-family: inherit; font-size: 15px; margin-top: 8px; box-sizing: border-box; background-color: #f9f9f9; }
        
        /* Input Readonly lebih gelap sedikit */
        .form-control[readonly] { background-color: #e0e0e0; color: #555; cursor: not-allowed; border-color: #ccc; }

        .btn { width: 100%; padding: 16px; border: none; border-radius: 50px; font-weight: 800; font-size: 16px; cursor: pointer; transition: 0.3s; color: white; margin-top: 20px; text-transform: uppercase; }
        .btn-start { background: #e53935; box-shadow: 0 4px 10px rgba(229, 57, 53, 0.4); } 
        .btn-submit { background: #2e7d32; box-shadow: 0 4px 10px rgba(46, 125, 50, 0.4); }
        
        #area-hasil { display: none; text-align: center; padding: 40px 20px; }
        .score-circle { width: 150px; height: 150px; background: #e53935; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 50px; font-weight: 800; margin: 20px auto; border: 8px solid #ffcdd2; }
        
        .resume-alert { background: #e3f2fd; color: #0d47a1; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #90caf9; display: none; text-align: center; font-weight: bold; }
        
        @keyframes blink { 50% { background-color: #b71c1c; } }
        .critical { animation: blink 1s infinite; }
    </style>
</head>
<body>

    <div id="timer-bar" class="timer-bar">
        ‚è≥ SISA WAKTU: <span id="time-display">--:--</span>
    </div>

    <div class="container">
        <div id="area-identitas">
            <h2 style="text-align:center; color:#b71c1c; margin-top:0;">üìã DATA SISWA KELAS 1</h2>
            
            <div id="resume-msg" class="resume-alert">
                üì¢ Melanjutkan pengerjaan sebelumnya...
            </div>

            <div style="margin-bottom:15px">
                <label>Nama Lengkap:</label>
                <input type="text" id="siswa_nama" class="form-control" readonly placeholder="Nama otomatis dari Login...">
            </div>
            
            <div style="margin-bottom:15px">
                <label>Kelas:</label>
                <input type="text" id="siswa_kelas" class="form-control" readonly placeholder="Kelas otomatis dari Login...">
            </div>

            <div style="margin-bottom:15px">
                <label>Asal Sekolah:</label>
                <input type="text" id="siswa_sekolah" class="form-control" placeholder="Ketik Nama Sekolahmu disini..."> 
            </div>
            
            <div style="margin-bottom:15px">
                <label>Nama Guru:</label>
                <input type="text" id="siswa_guru" class="form-control" placeholder="Ketik Nama Guru PJOK...">
            </div>
            
            <div style="text-align:center; margin-top:20px; color:#777; font-size:14px;" id="info-soal-count"></div>
            <button class="btn btn-start" onclick="mulaiKuis()">üöÄ MULAI / LANJUTKAN</button>
        </div>

        <div id="area-soal" style="display:none;">
            <div id="box-soal"></div>
            <button class="btn btn-submit" onclick="konfirmasiSelesai()">‚úÖ KIRIM JAWABAN</button>
        </div>

        <div id="area-hasil">
            <h2>HEBAT!</h2>
            <div class="score-circle" id="skor-tampil">0</div>
            <p style="font-size:18px;">Jawabanmu sudah terkirim ke Pak Guru.</p>
            <button class="btn" style="background:#555" onclick="window.location.href='materi-kelas-1.html'">üè† KEMBALI KE MATERI</button>
        </div>
    </div>

    <script>
        // --- 1. KONFIGURASI KHUSUS KELAS 1 ---
        const KELAS = '1'; 
        const firebaseConfig = { apiKey: "AIzaSyD7FsbgyUF1jvDvcrb6wrWlEiQJUFZG3kE", authDomain: "pjok-sekolah-bapak-rendi.firebaseapp.com", databaseURL: "https://pjok-sekolah-bapak-rendi-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "pjok-sekolah-bapak-rendi", appId: "1:337016584526:web:8534c7cf4012a35427861f" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        const params = new URLSearchParams(window.location.search);
        const bab = params.get('bab') || 'A';
        const STORAGE_KEY = `pjok_progress_k${KELAS}_${bab}_`; 
        
        let dataSoal = null;
        let timerInterval;
        let durasiDetik = 0;

        // --- 2. SAAT HALAMAN DIMUAT (LOAD DATA LOGIN) ---
        document.addEventListener('DOMContentLoaded', () => {
            // LOAD BANK SOAL
            if(window.BANK_SOAL_1 && window.BANK_SOAL_1[bab]) {
                dataSoal = window.BANK_SOAL_1[bab];
                
                // Durasi
                const isUjian = (bab === 'STS' || bab === 'SAS');
                const defaultWaktu = isUjian ? 5400 : 3600; // 90 Menit / 60 Menit
                
                // Cek Waktu Tersimpan
                const savedTime = localStorage.getItem(STORAGE_KEY + 'waktu');
                if(savedTime && parseInt(savedTime) > 0) {
                    durasiDetik = parseInt(savedTime);
                    document.getElementById('resume-msg').style.display = 'block'; 
                } else {
                    durasiDetik = defaultWaktu;
                }

                // Info Soal
                let totalSoal = (dataSoal.pg?.length||0) + (dataSoal.isian?.length||0) + (dataSoal.essay?.length||0);
                document.getElementById('info-soal-count').innerText = `Materi: ${bab} | Total: ${totalSoal} Soal`;

            } else {
                alert("‚ö†Ô∏è Data Soal tidak ditemukan!");
                window.location.href = 'materi-kelas-1.html';
                return;
            }

            // --- AUTO FILL DARI LOGIN (LOCAL STORAGE) ---
            if(localStorage.getItem('siswa_nama')) {
                document.getElementById('siswa_nama').value = localStorage.getItem('siswa_nama');
            }
            if(localStorage.getItem('siswa_kelas')) {
                document.getElementById('siswa_kelas').value = localStorage.getItem('siswa_kelas');
            }
            // Mengisi Sekolah jika pernah diisi sebelumnya (tapi tetap bisa diedit)
            if(localStorage.getItem('siswa_sekolah')) {
                document.getElementById('siswa_sekolah').value = localStorage.getItem('siswa_sekolah');
            }
            if(localStorage.getItem('siswa_guru')) {
                document.getElementById('siswa_guru').value = localStorage.getItem('siswa_guru');
            }
        });

        // --- 3. MULAI KUIS ---
        function mulaiKuis() {
            // Validasi Data
            const nama = document.getElementById('siswa_nama').value;
            const kelas = document.getElementById('siswa_kelas').value;
            const sekolah = document.getElementById('siswa_sekolah').value;
            const guru = document.getElementById('siswa_guru').value;
            
            if(!nama || !kelas) { 
                alert("Data Login tidak ditemukan. Silakan Login ulang dari halaman utama."); 
                return; 
            }
            if(!sekolah) {
                alert("Silakan isi Asal Sekolah!");
                return;
            }
            if(!guru) {
                alert("Silakan isi Nama Guru PJOK!");
                return;
            }

            // Simpan Data Sekolah & Guru agar terekam untuk selanjutnya
            localStorage.setItem('siswa_sekolah', sekolah);
            localStorage.setItem('siswa_guru', guru);

            // Ganti Tampilan
            document.getElementById('area-identitas').style.display = 'none';
            document.getElementById('area-soal').style.display = 'block';
            document.getElementById('timer-bar').style.display = 'block';

            renderSoal();
            restoreJawaban();
            jalankanTimer();
        }

        // --- 4. RENDER SOAL ---
        function renderSoal() {
            let html = "";
            let no = 1;

            // PG
            if(dataSoal.pg && dataSoal.pg.length > 0) {
                html += `<div class="section-header">I. PILIHAN GANDA</div>`;
                dataSoal.pg.forEach((s, i) => {
                    html += `<div class="soal-card">
                        <span class="number-badge">${no}</span> <b>${s.q}</b>
                        <div style="margin-top:10px;">
                            ${s.opt.map((o, idx) => `
                                <label class="option-label">
                                    <input type="radio" name="pg_${i}" value="${idx}" onchange="simpanJawaban('pg_${i}', ${idx})"> 
                                    <span>${String.fromCharCode(65+idx)}. ${o}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>`;
                    no++;
                });
            }

            // Isian
            if(dataSoal.isian && dataSoal.isian.length > 0) {
                html += `<div class="section-header">II. ISIAN SINGKAT</div>`;
                dataSoal.isian.forEach((s, i) => {
                    html += `<div class="soal-card">
                        <span class="number-badge">${no}</span> <b>${s}</b><br>
                        <input type="text" id="isian_${i}" class="form-control" placeholder="Jawab disini..." oninput="simpanJawaban('isian_${i}', this.value)">
                    </div>`;
                    no++;
                });
            }

            // Essay
            let labelEssay = (dataSoal.isian && dataSoal.isian.length > 0) ? "III" : "II";
            if(dataSoal.essay && dataSoal.essay.length > 0) {
                html += `<div class="section-header">${labelEssay}. URAIAN</div>`;
                dataSoal.essay.forEach((s, i) => {
                    html += `<div class="soal-card">
                        <span class="number-badge">${no}</span> <b>${s}</b><br>
                        <textarea id="essay_${i}" class="form-control" rows="3" placeholder="Jawab disini..." oninput="simpanJawaban('essay_${i}', this.value)"></textarea>
                    </div>`;
                    no++;
                });
            }

            document.getElementById('box-soal').innerHTML = html;
            window.scrollTo(0, 0);
        }

        // --- 5. AUTO SAVE & RESTORE ---
        window.simpanJawaban = function(key, val) {
            localStorage.setItem(STORAGE_KEY + key, val);
        }

        function restoreJawaban() {
            if(dataSoal.pg) {
                dataSoal.pg.forEach((_, i) => {
                    const val = localStorage.getItem(STORAGE_KEY + `pg_${i}`);
                    if(val !== null) {
                        const el = document.querySelector(`input[name="pg_${i}"][value="${val}"]`);
                        if(el) el.checked = true;
                    }
                });
            }
            if(dataSoal.isian) {
                dataSoal.isian.forEach((_, i) => {
                    const val = localStorage.getItem(STORAGE_KEY + `isian_${i}`);
                    if(val) document.getElementById(`isian_${i}`).value = val;
                });
            }
            if(dataSoal.essay) {
                dataSoal.essay.forEach((_, i) => {
                    const val = localStorage.getItem(STORAGE_KEY + `essay_${i}`);
                    if(val) document.getElementById(`essay_${i}`).value = val;
                });
            }
        }

        function bersihkanData() {
            Object.keys(localStorage).forEach((key) => {
                if(key.startsWith(STORAGE_KEY)) localStorage.removeItem(key);
            });
        }

        // --- 6. TIMER ---
        function jalankanTimer() {
            const display = document.getElementById('time-display');
            const bar = document.getElementById('timer-bar');

            timerInterval = setInterval(() => {
                localStorage.setItem(STORAGE_KEY + 'waktu', durasiDetik);

                let m = Math.floor(durasiDetik / 60);
                let s = durasiDetik % 60;
                display.innerText = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;

                if(durasiDetik < 300) {
                    bar.classList.add('critical');
                    bar.innerHTML = `‚ö†Ô∏è WAKTU HABIS SEBENTAR LAGI: ${display.innerText}`;
                }

                if(durasiDetik <= 0) {
                    clearInterval(timerInterval);
                    alert("‚è∞ WAKTU HABIS! Jawaban dikirim otomatis.");
                    prosesSelesai(true);
                }
                durasiDetik--;
            }, 1000);
        }

        // --- 7. KIRIM DATA ---
        window.konfirmasiSelesai = function() {
            if(confirm("Yakin ingin mengumpulkan?")) {
                prosesSelesai(false);
            }
        }

        function prosesSelesai(isAuto) {
            clearInterval(timerInterval);
            document.getElementById('timer-bar').style.display = 'none';

            let benar = 0;
            if(dataSoal.pg) {
                dataSoal.pg.forEach((s, i) => {
                    const el = document.querySelector(`input[name="pg_${i}"]:checked`);
                    if(el && parseInt(el.value) === s.ans) benar++;
                });
            }
            const skor = dataSoal.pg.length > 0 ? Math.round((benar / dataSoal.pg.length) * 100) : 0;

            const dataKirim = {
                nama: document.getElementById('siswa_nama').value,
                kelas: document.getElementById('siswa_kelas').value, 
                sekolah: document.getElementById('siswa_sekolah').value,
                guru: document.getElementById('siswa_guru').value,
                nilai_pg: skor,
                waktu_selesai: new Date().toLocaleString(),
                status: isAuto ? "Otomatis" : "Manual"
            };

            db.ref(`hasil_kuis/kelas_${KELAS}/${bab}/${Date.now()}`).set(dataKirim).then(() => {
                bersihkanData(); 
                document.getElementById('area-soal').style.display = 'none';
                document.getElementById('area-hasil').style.display = 'block';
                document.getElementById('skor-tampil').innerText = skor;
            }).catch(err => {
                alert("Gagal mengirim nilai. Cek koneksi!");
            });
        }
    </script>
</body>
</html>